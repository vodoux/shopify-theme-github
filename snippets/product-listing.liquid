<div class="product-index-inner">
  {% if product.available %}
    {% for col in product.collections %}
      {% if col.handle == 'new' %}
        <div class="new icn">{{ 'products.general.new' | t }}</div>
      {% endif %}
    {% endfor %}

    {% if product.price < product.compare_at_price %}
      <div class="sale-item sale-item--{{ settings.sale_items }} icn">
      {% case settings.sale_items %}
        {% when 'percentage' %}
          {% if product.price_varies or product.compare_at_price_varies %}
            {{ 'products.general.sale' | t }}
          {% else %}
            {% assign discount = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price %}
            {% assign discount = discount | round | append: '%' %}
            {{ 'products.general.savings' | t: savings: discount }}
          {% endif %}
        {% when 'amount' %}
          {% if product.price_varies or product.compare_at_price_varies %}
            {{ 'products.general.sale' | t }}
          {% else %}
            {% assign discount = product.compare_at_price | minus: product.price | money %}
            {{ 'products.general.savings' | t: savings: discount }}
          {% endif %}
        {% when 'icon' %}
          {{ 'products.general.sale' | t }}
      {% endcase %}
      </div><!-- /.sale-item -->
    {% endif %}

  {% if product.template_suffix == 'pre-order' %}
  <div class="pre-order icn {{ settings.icon_style }}">{{ 'products.product.pre_order' | t }}</div>
  {% endif %}

  {% else %}
    <div class="so icn">{{ 'products.general.sold' | t }}</div>
  {% endif %}

  <div class="prod-image">
    <a href="{{ product.url }}" title="{{ product.title | escape }}">
      <div class="reveal">
        {%- if product.media.size < 1 -%}
          <div class="box-ratio" style="padding-bottom: 100%;">
            {% capture current %}{% cycle 1, 2, 3, 4, 5, 6 %}{% endcapture %}
            {{ 'product-' | append: current | placeholder_svg_tag: 'placeholder-svg' }}
          </div>
        {%- else -%}
          {%- liquid

            if settings.image_flip and product.images.size > 1
              assign class = 'first-image'
              assign second_image = product.media[1]
            endif

            case grid
              when 2
                assign width = '1000'
              when 3
                assign width = '800'
              when 4
                assign width = '600'
              else
                assign width = '500'
            endcase

          -%}

          {% if product.featured_media.media_type == 'video'
                or product.featured_media.media_type == 'external_video' %}

            {% if settings.product_grid_video %}

              {% render 'product-loop-video', product: product %}

            {% endif %}

            {%
              render 'basic-responsive-image',
              type: product.featured_media.preview_image,
              width: width,
              loading: loading,
              fetchpriority: fetchpriority
            %}

          {% else %}

            {%
              render 'basic-responsive-image',
              type: product.featured_media,
              width: 700,
              loading: loading,
              fetchpriority: fetchpriority
            %}

          {% endif %}

          {% if settings.image_flip and product.media.size > 1 and second_image.media_type == 'image' %}
            <div class="hidden">
               {% render 'basic-responsive-image',
                 type: product.media[1],
                 width: width,
                 class: class
               %}
             </div>
          {% elsif settings.image_flip and product.media.size > 1 and second_image.media_type != 'image' %}
            <div class="hidden">
               {% render 'basic-responsive-image',
                type: product.media[1].preview_image,
                width: width
               %}
             </div>
          {% endif %}
        {%- endif -%}
      </div>
    </a>
  </div>

  {% if settings.quickview or settings.quick_add %}
    <div class="product__grid--buttons">
      {% if settings.quickview %}
        <button class="quick-view-{{ product.id }} product-listing__quickview-trigger js-modal-open js-quickview-trigger" type="button" name="button" data-wau-modal-target="quickview" data-product-url="/products/{{ product.handle }}?view=quick">
          {% render 'snip-icons',
             wrapper: '.product-listing__quickview-trigger',
             type: 'vantage-theme',
             icon: 'search',
             size: '18px',
             fill: 'var(--directional-color)',
             hover: 'var(--directional-color)' %}
        </button>
      {% endif %}

      {% if settings.quick_add and product.available %}
        {% render 'product-grid-add', product: product %}
      {% endif %}
    </div>
  {% endif %}

</div>

<div class="product-info">
  <div class="product-info-inner">
    <h3 class="product-title h5">
      <a href="{{ product.url }}">
        {{ product.title }}
      </a>
    </h3>
    {% if settings.vendor %}
      <p class="product-vendor">{{ product.vendor }}</p>
    {% endif %}

    {% render 'product-price-listing', product: product %}

    {%- if settings.show_rating and product.metafields.reviews.rating.value != blank -%}
      <div class="product__section--rating-wrapper">
        {% liquid
          assign rating_decimal = 0
          assign decimal = product.metafields.reviews.rating.value.rating | modulo: 1
          if decimal >= 0.3 and decimal <= 0.7
            assign rating_decimal = 0.5
          elsif decimal > 0.7
            assign rating_decimal = 1
          endif
        %}
        <div class="product__section-rating" role="img" aria-label="{{ 'accessibility.star_reviews_info' | t: rating_value: product.metafields.reviews.rating.value, rating_max: product.metafields.reviews.rating.value.scale_max }}">
          <span aria-hidden="true" class="product__section-rating-star color-icon" style="--rating: {{ product.metafields.reviews.rating.value.rating | floor }}; --rating-max: {{ product.metafields.reviews.rating.value.scale_max }}; --rating-decimal: {{ rating_decimal }};"></span>
        </div>
        <p class="product__section-rating-text caption">
          <span aria-hidden="true">{{ product.metafields.reviews.rating.value }} / {{ product.metafields.reviews.rating.value.scale_max }}</span>
        </p>
        <p class="product__section-rating-count caption">
          <span aria-hidden="true">({{ product.metafields.reviews.rating_count }})</span>
          <span class="visually-hidden">{{ product.metafields.reviews.rating_count }} {{ "accessibility.total_reviews" | t }}</span>
        </p>
      </div>
    {%- endif -%}

    <div class="clear"></div>

    <div class="product_listing_options">
    {%- liquid

    if product.variants.size >= 1
      if settings.show_colors and product.available
        render 'show-colors', product: product
      endif
       if settings.show_sizes and product.available
         render 'show-sizes', product: product
        endif
     endif

    -%}
    </div><!-- /.product_listing_options -->

    {% form 'product', product, data-product-form: product_form_config %}
      <input  type="hidden" id="{{ variant.id }}" name="id" value="{{ variant.id }}"/>
      <div class="note note-success mt3 js-added-msg" style="display: none">
        <strong>{{ 'products.product.added' | t }}</strong> <a class="underline" href="{{ routes.cart_url }}">{{ 'products.product.view_cart' | t }}</a> {{ 'products.product.or' | t }} <a class="underline" href="{{ routes.all_products_collection_url }}">{{ 'products.product.continue' | t }}</a>.
      </div>
      <div class="note note-error js-error-msg" style="display: none">
        <strong>{{ 'cart.general.cart_error' | t }}</strong> {{ 'cart.general.update_qty_error' | t }}
      </div>
      {{ value | escape | link_to: '#', class: 'add js-ajax-submit visually-hidden' }}
    {% endform %}

  </div>
</div>
