{% comment %}
  ASCII Logo Section with Hover Glitch Effect (Optimized)

  INSTALLATION:
  1. Admin Shopify → Boutique en ligne → Thèmes → Modifier le code
  2. Dossier "Sections" → Ajouter une nouvelle section
  3. Nommez-la "ascii-logo" et collez tout ce code
  4. Sauvegardez
  5. Personnaliser le thème → Ajouter une section → "ASCII Logo"

  POUR CHANGER LE LOGO:
  Modifiez le contenu entre les balises <pre id="ascii-raw-..."> ci-dessous.
  Chaque espace compte — ne reformatez pas le contenu.
{% endcomment %}

<style>
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

  .ascii-logo-section-{{ section.id }} {
    background: {{ section.settings.bg_color }};
    padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    position: relative;
  }

  .ascii-logo-container-{{ section.id }} {
    position: relative;
    cursor: crosshair;
  }

  .ascii-logo-container-{{ section.id }} .al {
    white-space: pre;
    font-size: {{ section.settings.font_size }}px;
    line-height: 1.15;
    letter-spacing: 0.02em;
    font-family: 'JetBrains Mono', monospace;
    color: {{ section.settings.text_color }};
    display: block;
    margin: 0;
    padding: 0;
  }

  .ascii-logo-container-{{ section.id }} .al span {
    display: inline;
    cursor: crosshair;
  }

  #ascii-raw-{{ section.id }} {
    display: none;
  }

  @media screen and (max-width: 768px) {
    .ascii-logo-container-{{ section.id }} {
      transform: scale({{ section.settings.mobile_scale }});
      transform-origin: center center;
    }
  }
</style>

<div class="ascii-logo-section-{{ section.id }}">
  <div class="ascii-logo-container-{{ section.id }}" id="ascii-logo-{{ section.id }}"></div>
</div>

<pre id="ascii-raw-{{ section.id }}">
                                                        ..-==++**##%%%%%%%%%%%%%%%%%%%%##***+==-:.                                                        
                                                  :=*#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#*=:                                                  
                                             .-*%%%%%%%%%%%%%%%%%+==%=:-%%+::*%%---==*%%%%%%%#%%%%%%%%%%%%*-.                                             
                                          .+%%%%%%%%%%%%%-.  .#%%.  :- :%%+  *%#  .::+%%%%%%+  .=%%%%%%%%%%%%%+:                                          
                                       .=%%%%%%%*-.:%%%%+ .##%%%%: ..  .%%+  #%#  .:%%%%%%%%- .: -%%%: .=#%%%%%%%+.                                       
                                     :#%%%%%%%%%-   .#%%- -%.  +%: .*. .%%+  #%*  =+%%%%%%%%: += .%%- .-. +%%%%%%%%%-                                     
                                  .-%%%%%%+--*%%#..+ .#%*. -=  *%: .%+. *%+  *%+     #%%%%%#..-..*%*.  :%%%%%%%%%%%%%%=.                                  
                                .:#%%%%#:..:. .%#.     +%*:  .*%%*-=%%++#%#**%%%##***%%%%%%=..:-%%*  -##%%%%%%%%%%%%%%%%-.                                
                               .#%%%%%%%#. :- .%%: .%=:+%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%*-.  :%%%%%%%*-..:*%%%%#:.                              
                             .-%%%%#*%%%%%:  .#%%+-*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%##%%%%%#. .--. =%%%%%+.                             
                            .*%%%%+  .-%%%%-..+%%%%%%%%%%%%#*=-:..                      ..:-=+#%%%%%%%%%%%%%#. -%%%%*#%%%%%%#.                            
                           .#%%%%%%.    .*%%=-%%%%%%%%*=.                                         :*%%%%%%%%#. :+%%%%%%%%%%%%%:                           
                          :%%%%+     .%-. .#%%%%%%%+.                                                .=%%%%%%%-..=%%%%%#+:*%%%%-                          
                         .%%%%%+.. .***%%+#%%%%%*.                                                      .*%%%%%%%#+-.     .#%%%%:                         
                        .%%%%%%%%%-. .+%%%%%%%*...                                                        .#%%%%%+... -. .*%%%%%%:                        
                       .*%%%%#**#%%%+..*%%%%%=.+#.                                                          -%%%%%%%-  .*%%%%%%%%%.                       
                       =%%%#.     .=%%%%%%%%=            ..:=*%%%%#+:.              .=#%%%%*-..              -%%%%%%..#%%%%%%#%%%%*.                      
                      .%%%%= .#%%+. -%%%%%%%.=-       .=%%%%%%%%%%%%%%:           .%%%%%%%%%%%%+.            .%%%%%%%%%#*:.   =%%%%.                      
                      +%%%%%:.     .=%%%%%%=.%.     .+%%%%%%%%%%%%%%%%#           *%%%%%%%%%%%%%#.            *#*%%%%*.... .=  #%%%#.                     
                     .%%%%%%%%#-..-#%%%%%*%.-#.   .-%%%%%%%%%%%%%%%%%%.          :%%%%%%%%%%%%%%%:            +%.#%%%%%%%%:+%-.=%%%%:                     
                     -%%%%%#%%%%%%%%%%%%=+% =*.   +%%%%%%%%%#%%%%%%%#.           =%%%%%%=..#%%%%%%+..         +%:+%%%%%%%%%%%%%%%%%%=                     
                     +%%%* .+%%%. +%%%%%+=%..*. .=%%%%%%%%-:%%%%%%#:#%%*.        +%%%%%#..-%%%%%%%%%%%:.     .#%%.#%%%%-        #%%%*                     
                     *%%%+ .*%%%- :%%%%+.#%.    .#%%%%%%*.#%%%%%#-%%%%%%*.       =%%%%%%%%%%%%%%%%%%%%%+     .%%=#=%%%%= .+..*. +::%#                     
                     #%%%%*       *%%%%=-*%-    .#%%%%%.*%%%%%%:#%%%%%%%+        :%%%%%%%%%%.   .#%%%%%%.    :%%+ -%%%%+ .%%%%: -%%%%                     
                     %%%%%%%%%%%%%%%%%%-  %+      -+- =%%%%%%==%%%%%%%%#   ..:.   *%%%%%%%%+    =%%%%%%%:    :%%%--%%%%%%%%%%%%%%%%%%                     
                     %%%%%%%%%%%%%%%%%%#+ %*        .#%%%%%%%%%%%%%%%%#.  +%%%%+  :%%%%%%%%%%%%%%%%%%%%%.    .%%:.-%%%%%%%%%%%%%%%%%%                     
                     %%%%%%%%%%%%%%%%%%= .%-       .#%%%%%%%%%%%%%%%%-.  =%%%%%%=  :%%%%%%%%%%%%%%%%%%%-      -%#.*%%%%%%%%%%%%%%%%%%                     
                     #%%%%%%%%%%%%%%%%%+ =#.       .%%%%%%%%%%%%%%%-.   :%%%%%%%%.  .#%%%%%%%%%%%%%%%#.     -*.=%==%%%%%%%%%%%%%%%%%#                     
                     +%%%%%%%%%%%%%%%%%%+%+  .-    .#%%%%%%%%%%%*..    .%%%*.=%%%=   ..+%%%%%%%%%%%=.        ..:%%%%%%%%%%%%%%%%%%%%*                     
                     =%%%%%%%%%%%%%%%%%%%%=.-:%:    .-%%%%%%*:..      .%%%%*.=%%%%-      .........           ::.%%%%%%%.*%%%%%%%%%%%=                     
                     :%%%%%%#:.. ..+%%%%%%+.* :%=.                   :%%%%%%%%%%%%%-                      =: #=:%%%%%%= ..#%%%%%%%%%:                     
                     .#%%%%-..-##*..+%%%%%%:    ..  ...             -%%%%%%%%%%%%%%%+                  -*=. *#.*%%%%%%*+  ..-*%%%%%#.                     
                      .%%%%. :%%%%-.#%%%%%%%= .+%%*-...=**+-.      .#%%%%%%%%%%%%%%%%.       :#%%%%#*-.  .#*::%%%%%%#.        :%%%%.                      
                       +%%%%: -%%%%%%%%%%%%%%%#+++*#%%%%*.         .+%%%%%-...+%%%%%*           .#%%%%%%*==*%%%%%%%%%%%%%%%%%#%%%%*.                      
                       .#%%%%%%%%+:.  .*%%%%%%%%%%%%%%%%- =.:.       .::.      .:==:.        .#:.#%%%%%%%%%%%%%%%%#..+%%%%%%%%%%%#.                       
                        :%%%%%%*. .=#= .%%%%%%%%+*%%%:.*#...                                 :*.=%- :%%%%%%%%%%%%%%=. .-%%%%%%%%%:                        
                         :%%%%%: .%%=. :%%%%%%%%#..*=  -%:                                      *%  -%-..#%%%%%%:.      ..=%%%%%:                         
                          -%%%%+     :*%%=.+%%%%%%#=.  -%:                                      +%.  .=%%%%%%%%%#:  .=##=.=%%%%-                          
                           :%%%%%#*#%%%*.   .+%%%%%%%#+*%:                                      :%=+%%%%%%%%=..=%%%+.  :*%%%%%:                           
                            .#%%%%%%%#.   +#:-%%%%%%%%%%%%#*+-:.                         ..:-**#%%%%%%%%%%%%.   .-%%%#--%%%%#.                            
                             .=%%%%%=  =#=#%%%%- .-#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%+:.:+%#. -  .:#%%%%%%+.                             
                               :#%%%%#%%%%%%%%: .-. -%%*%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#%#. .-. :%*. .+:.*%%%%#:                               
                                .-%%%%%%%%%%%-  ..%%%%=    .#%--==+#%%%%%%%%%*#%%%%%+=+%%%*-:=%#  .%%#. -. :%%+..+%%%%%%-.                                
                                  .=%%%%%%%%: .#%%%%%%. :#*+%#. ...=%%%%%%*.   .#%+    .=%#   .:   =%%#.  =%%%%*#%%%%%=.                                  
                                     -#%%%%%#=%%%%%%%+....%%%#. .=%%%%%%%%..+%#%%%. -%- .#%. .: :: .%%%+  =%%%%%%%%%-                                     
                                       .+%%%%%%%%%%%%. .=+%%%*..++%%%%%%%* .#%%%%%: -%= .#%+ .%*%+  *%%%+=%%%%%%%+.                                       
                                          :+%%%%%%%%%+-:. *%%=    :%%%%%%%. :=.:#%*  .. :%%%. =%%%.:+%%%%%%%%%+:                                          
                                             .-*%%%%%%%%%%%%%%#*++*%%%%%%%%=..:*%%%%=:-*%%%%**%%%%%%%%%%%%*-.                                             
                                                  :=*#%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#*=:                                                  
                                                        ..-=++**###%%%%%%%%%%%%%%%%%%%%###**++=-..                                                        </pre>

<script>
(function() {
  var rawEl = document.getElementById('ascii-raw-{{ section.id }}');
  var container = document.getElementById('ascii-logo-{{ section.id }}');
  if (!rawEl || !container) return;

  var text = rawEl.textContent;
  if (text.charAt(0) === '\n') text = text.substring(1);
  if (text.charAt(text.length - 1) === '\n') text = text.substring(0, text.length - 1);

  var GLITCH = '\u2591\u2592\u2593\u2588\u2584\u2580\u25A0\u25A1\u25AA\u25AB\u25AC\u25B2\u25BA\u25BC\u25C4\u25CA\u25CB\u25CF\u25D8\u25D9\u263A\u263B\u2660\u2663\u2665\u2666';
  var HR = {{ section.settings.hover_radius }};
  var FS = {{ section.settings.font_size }};
  var CW = FS * 0.664;
  var CH = FS * 1.15;

  var allLines = text.split('\n');

  // Strip leading/trailing empty lines
  var firstContent = 0, lastContent = allLines.length - 1;
  while (firstContent < allLines.length && !allLines[firstContent].trim()) firstContent++;
  while (lastContent > firstContent && !allLines[lastContent].trim()) lastContent--;
  var lines = allLines.slice(firstContent, lastContent + 1);

  // Spatial grid: only store content chars with spans
  // Spaces become plain text nodes (no span, no event overhead)
  var contentChars = []; // {el, row, col, original}
  var dirty = [];        // chars currently glitched, for batch restore
  var lineCount = lines.length;

  // Build a spatial hash for fast lookup: grid cells of 8x8 chars
  var CELL = 8;
  var gridCols, gridRows, spatialGrid;

  function buildDOM() {
    var frag = document.createDocumentFragment();
    var maxCols = 0;

    for (var r = 0; r < lineCount; r++) {
      var line = lines[r];
      if (line.length > maxCols) maxCols = line.length;

      var lineEl = document.createElement('div');
      lineEl.className = 'al';

      // Group consecutive spaces into single text nodes
      var i = 0;
      while (i < line.length) {
        if (line[i].trim() === '') {
          // Collect consecutive spaces
          var start = i;
          while (i < line.length && line[i].trim() === '') i++;
          lineEl.appendChild(document.createTextNode(line.substring(start, i)));
        } else {
          // Content char → span
          var span = document.createElement('span');
          span.textContent = line[i];
          lineEl.appendChild(span);

          var entry = { el: span, row: r, col: i, original: line[i], restoreAt: 0 };
          contentChars.push(entry);
          i++;
        }
      }

      frag.appendChild(lineEl);
    }

    container.appendChild(frag);

    // Build spatial grid
    gridCols = Math.ceil(maxCols / CELL);
    gridRows = Math.ceil(lineCount / CELL);
    spatialGrid = new Array(gridRows * gridCols);
    for (var g = 0; g < spatialGrid.length; g++) spatialGrid[g] = [];

    for (var c = 0; c < contentChars.length; c++) {
      var ch = contentChars[c];
      var gi = Math.floor(ch.row / CELL) * gridCols + Math.floor(ch.col / CELL);
      spatialGrid[gi].push(ch);
    }
  }

  buildDOM();

  // ─── Hover Glitch (throttled with rAF) ───

  var isHovering = false;
  var pendingMove = null;
  var rafId = 0;
  var now = 0;

  function processMove() {
    rafId = 0;
    if (!pendingMove) return;

    var e = pendingMove;
    pendingMove = null;
    now = performance.now();

    var rect = container.getBoundingClientRect();
    var col = (e.clientX - rect.left) / CW;
    var row = (e.clientY - rect.top) / CH;

    // Only check spatial grid cells within hover radius
    var cellR1 = Math.max(0, Math.floor((row - HR) / CELL));
    var cellR2 = Math.min(gridRows - 1, Math.floor((row + HR) / CELL));
    var cellC1 = Math.max(0, Math.floor((col - HR) / CELL));
    var cellC2 = Math.min(gridCols - 1, Math.floor((col + HR) / CELL));

    for (var cr = cellR1; cr <= cellR2; cr++) {
      for (var cc = cellC1; cc <= cellC2; cc++) {
        var bucket = spatialGrid[cr * gridCols + cc];
        for (var b = 0; b < bucket.length; b++) {
          var c = bucket[b];
          var dx = c.col - col;
          var dy = c.row - row;
          var dist = Math.sqrt(dx * dx + dy * dy);

          if (dist < HR) {
            var intensity = 1 - (dist / HR);

            if (Math.random() < intensity * 0.6) {
              c.el.textContent = GLITCH[Math.floor(Math.random() * GLITCH.length)];
              var br = Math.floor(150 + intensity * 105);
              c.el.style.color = 'rgb(' + br + ',' + br + ',' + br + ')';
              // Schedule restore 80-280ms from now
              c.restoreAt = now + 80 + Math.random() * 200;
              if (dirty.indexOf(c) === -1) dirty.push(c);
            }
          }
        }
      }
    }

    // Restore expired dirty chars
    restoreDirty();
  }

  function restoreDirty() {
    var stillDirty = [];
    for (var i = 0; i < dirty.length; i++) {
      var c = dirty[i];
      if (now >= c.restoreAt) {
        c.el.textContent = c.original;
        c.el.style.color = '';
      } else {
        stillDirty.push(c);
      }
    }
    dirty = stillDirty;

    // Keep ticking if there are still dirty chars
    if (dirty.length > 0 && !rafId) {
      rafId = requestAnimationFrame(function() {
        rafId = 0;
        now = performance.now();
        restoreDirty();
      });
    }
  }

  container.addEventListener('mousemove', function(e) {
    isHovering = true;
    pendingMove = e;
    if (!rafId) {
      rafId = requestAnimationFrame(processMove);
    }
  });

  container.addEventListener('mouseleave', function() {
    isHovering = false;
    pendingMove = null;
    // Restore all after a short delay
    setTimeout(function() {
      if (!isHovering) {
        for (var i = 0; i < dirty.length; i++) {
          dirty[i].el.textContent = dirty[i].original;
          dirty[i].el.style.color = '';
        }
        dirty = [];
      }
    }, 300);
  });
})();
</script>

{% schema %}
{
  "name": "ASCII Logo",
  "tag": "section",
  "class": "ascii-logo-wrapper",
  "settings": [
    {
      "type": "range",
      "id": "font_size",
      "label": "Taille des caractères",
      "min": 3,
      "max": 12,
      "step": 0.5,
      "default": 6,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "hover_radius",
      "label": "Rayon de l'effet hover",
      "min": 3,
      "max": 20,
      "step": 1,
      "default": 8
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Couleur de fond",
      "default": "#0a0a0a"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Couleur du texte",
      "default": "#e8e8e8"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Espacement haut",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 60,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Espacement bas",
      "min": 0,
      "max": 200,
      "step": 10,
      "default": 60,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "mobile_scale",
      "label": "Échelle mobile",
      "min": 0.2,
      "max": 1,
      "step": 0.1,
      "default": 0.5
    }
  ],
  "presets": [
    {
      "name": "ASCII Logo"
    }
  ]
}
{% endschema %}
